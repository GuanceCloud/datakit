---
title     : 'Apache'
summary   : 'Apache collector can collect the number of requests, connections, etc. from the Apache service'
tags:
  - 'MIDDLEWARE'
  - 'WEB SERVER'
__int_icon      : 'icon/apache'
dashboard :
  - desc  : 'Apache'
    path  : 'dashboard/en/apache'
monitor   :
  - desc  : 'Apache'
    path  : 'monitor/en/apache'
---

{{.AvailableArchs}}

---

Apache collector can collect the number of requests, connections and others from Apache services, and collect indicators to <<<custom_key.brand_name>>> to help monitor and analyze various abnormal situations of Apache.

## Configuration {#config}

### Preconditions {#requirements}

- Apache version >= `2.4.6 (Unix)`. Already tested version:
    - [x] 2.4.56
    - [x] 2.4.54
    - [x] 2.4.41
    - [x] 2.4.38
    - [x] 2.4.29
    - [x] 2.4.6

- Default configuration path:
    - */etc/apache2/apache2.conf*
    - */etc/apache2/httpd.conf*
    - */usr/local/apache2/conf/httpd.conf*

- Open Apache `mod_status` and add the followings in Apache profile:

```xml
<Location /server-status>
SetHandler server-status

Order Deny,Allow
Deny from all
Allow from [YOUR_IP]
</Location>
```

- Restart Apache

```shell
sudo apachectl restart
```

### Collector Configuration {#input-config}

<!-- markdownlint-disable MD046 -->
=== "Host installation"

    Go to the `conf.d/{{.Catalog}}` directory under the DataKit installation directory, copy `{{.InputName}}.conf.sample` and name it `{{.InputName}}.conf`. Examples are as follows:
    
    ```toml
    {{ CodeBlock .InputSample 4 }}
    ```
    
    After configuration, [restart DataKit](../datakit/datakit-service-how-to.md#manage-service).

=== "Kubernetes"

    The collector can now be turned on by [configMap injection collector configuration](../datakit/datakit-daemonset-deploy.md#configmap-setting).

## Metric {#metric}

For all of the following data collections, the global election tags will added automatically, we can add extra tags in `[inputs.{{.InputName}}.tags]` if needed:

``` toml
 [inputs.apache.tags]
  # some_tag = "some_value"
  # more_tag = "some_other_value"
  # ...
```

{{ range $i, $m := .Measurements }}
{{if eq $m.Type "metric"}}

### `{{$m.Name}}`

{{$m.Desc}}

- Tags

{{$m.TagsMarkdownTable}}

- Metrics

{{$m.FieldsMarkdownTable}}
{{ end }}
{{ end }}

## Custom Object {#object}

{{ range $i, $m := .Measurements }}

{{if eq $m.Type "custom_object"}}

### `{{$m.Name}}`

{{$m.Desc}}

- Tags

{{$m.TagsMarkdownTable}}

- Metrics

{{$m.FieldsMarkdownTable}}
{{end}}

{{ end }}

## Log Collection {#logging}

To collect the Apache log, open  `files` in {{.InputName}}.conf and write to the absolute path of the Apache log file. For example:

```toml
[[inputs.{{.InputName}}]]
  ...
  [inputs.{{.InputName}}.log]
    files = [
      "/var/log/apache2/error.log",
      "/var/log/apache2/access.log"
    ]
```

When log collection is turned on, logs with `apache` log (`source`) will be generated by default.

<!-- markdownlint-disable MD046 -->
???+ attention

    DataKit must be installed on the host where Apache is located to collect Apache logs.
<!-- markdownlint-enable -->

## Log Pipeline Function Cut Field Description {#pipeline}

- Apache Error Log Cutting

Error Log Text Example

```log
[Tue May 19 18:39:45.272121 2021] [access_compat:error] [pid 9802] [client ::1:50547] AH01797: client denied by server configuration: /Library/WebServer/Documents/server-status
```

The list of cut fields is as follows:

| Field Name   | Field Value                | Description                         |
| ---      | ---                   | ---                          |
| `status` | `error`               | log level                     |
| `pid`    | `9802`                | process id                      |
| `type`   | `access_compat`       | log type                     |
| `time`   | `1621391985000000000` | nanosecond timestamp (as row protocol time) |

- Apache Access Log Cutting

Example of access log text:

```log
127.0.0.1 - - [17/May/2021:14:51:09 +0800] "GET /server-status?auto HTTP/1.1" 200 917
```

The list of cut fields is as follows:

| Field Name         | Field Value                | Description                         |
| ---            | ---                   | ---                          |
| `status`       | `info`                | log level                     |
| `ip_or_host`   | `127.0.0.1`           | requester ip or host             |
| `http_code`    | `200`                 | http status code             |
| `http_method`  | `GET`                 | http request type                |
| `http_url`     | `/`                   | http request url                 |
| `http_version` | `1.1`                 | http version                 |
| `time`         | `1621205469000000000` | nanosecond timestamp (as row protocol time) |
